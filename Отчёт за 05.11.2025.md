# Отчёт по работе над проектом BitrixCorp

## Введение
Задача: создать приложение на FastAPI, которое по запросу генерирует 100 компаний и 100 контактов, связывает их, отображает на HTML‑странице и поддерживает работу через вебхуки Bitrix24. В ходе работ проект был упрощён до модели без локальной БД: все данные создаются/читаются/удаляются напрямую в Bitrix24.

## Итоговая функциональность
- Генерация 100 компаний и 100 контактов с ФИО (включая отчество), телефоном и привязкой контакта к компании.
- Отображение двух таблиц на одной HTML‑странице: «Компании» (с составом участников) и «Контакты».
- Очистка всех компаний и контактов в Bitrix24.
- Реальный прогресс выполнения (проценты + индикатор) через SSE.
- Пакетные операции (Batch API) с шагом 50 команд, чтобы не плодить множество параллельных потоков.
- Централизация запуска: глобальный async‑лок на сервере, запрет на параллельные операции из нескольких вкладок.
- Кнопки запуска прямо на странице, автообновление по завершении.

## Ключевые решения и технологии
- FastAPI (сервер), Jinja2 (шаблон), httpx (REST‑клиент), Faker (генерация данных), SSE (Server‑Sent Events) для прогресса.
- Полный отказ от локальной БД: чтение текущих данных через `crm.company.list` и `crm.contact.list`.
- Batch API Bitrix (`batch.json`) для пакетного добавления/удаления (по 50 команд за вызов).
- Ретраи с экспоненциальным бэкофом при 429/5xx и неблокирующие задержки.

## Архитектура
- `app/bitrix_client.py`: клиент Bitrix (одиночные и batch‑методы create/list/delete, ретраи, бэкоф).
- `app/routers/webhook.py`: 
  - `GET /bitrix/webhook/push-stream` — создание (Batch) с прогрессом (SSE),
  - `GET /bitrix/clear-stream` — удаление (Batch) с прогрессом (SSE),
  - `GET /bitrix/status` — статуса занятости,
  - также сохранены POST‑маршруты без прогресса.
- `app/main.py`: отдаёт HTML и собирает данные из Bitrix на лету.
- `app/templates/index.html`: две таблицы + кнопки управления + индикатор прогресса; блокировка кнопок, если сервис занят.

## Прогресс и централизованность
- Прогресс в процентах: 1% за каждые 2 обработанных элемента (из 200 операций при «100+100»). Для очистки — сначала контакты, затем компании; для создания — наоборот.
- Глобальный `asyncio.Lock` не даёт запустить несколько операций одновременно. Эндпоинт `GET /bitrix/status` позволяет клиенту заранее отключать кнопки.

## Работа с Batch API
- Создание компаний/контактов: разбиение входных массивов на чанки по 50, последовательные вызовы `batch.json`.
- Удаление контактов/компаний: аналогично — батчи по 50.
- В `push-stream` исправлена логика накопления ID компаний: контакты создаются для всех созданных компаний (а не только для последнего батча).

## Запуск и удобство использования
- `run_server.py` — запуск сервера (127.0.0.1:8000, reload) одной командой `python run_server.py`.
- `StartBitrixCorp.bat` — бат‑файл для Windows: активирует venv (если есть), запускает сервер, открывает браузер.
- `download_portal.py` + `StartDownloadPortal.bat` — локальная страница с кнопкой «Скачать проект» (упаковка в ZIP и выдача файла по HTTP на 127.0.0.1:9000).

## Настройка вебхука
- Вебхук по умолчанию захардкожен в `app/bitrix_client.py` (константа `BITRIX_WEBHOOK_URL`), формат `https://<портал>.bitrix24.ru/rest/<USER_ID>/<TOKEN>/`.
- Должны быть права CRM (crm.*). Ссылка `.../profile.json` должна возвращать JSON профиля.
- (Опционально) `BITRIX_WEBHOOK_SECRET` — секрет для защиты серверных эндпоинтов; UI подставляет его автоматически.

## Итоги
Проект решает задачи генерации/очистки и отображения компаний/контактов, работает без локальной БД, использует пакетные операции и даёт пользователю наглядный прогресс. Встроены меры для предотвращения параллельных запусков и для удобного локального старта.
