# BitrixCorp — отчёт по проекту

## Обзор
BitrixCorp — это веб‑приложение на FastAPI, которое без локальной БД создаёт и удаляет компании и контакты непосредственно в Bitrix24 через REST API, а также отображает текущие данные на HTML‑странице. Поддерживается прогресс выполнения (через SSE), пакетные операции (Batch API), а также централизованное выполнение (глобальный лок), чтобы исключить параллельные запускы из нескольких вкладок.

## Ключевые возможности
- Создание 100 компаний и 100 контактов в Bitrix24 за один запуск.
- У каждого контакта задаются: фамилия, имя, отчество (SECOND_NAME), телефон и привязка к компании.
- Отображение на странице двух таблиц: компании (со списком участников) и контакты.
- Удаление всех контактов и компаний из CRM одним действием.
- Реальный прогресс (проценты + индикатор) через Server‑Sent Events.
- Пакетные вызовы к Bitrix (Batch API) партиями по 50 команд.
- Централизация выполнения: глобальный async‑лок на сервере предотвращает одновременные операции.

## Как это работает (архитектура)
- `app/bitrix_client.py` — клиент к Bitrix REST: одиночные и пакетные методы (create/list/delete и batch‑варианты). Встроены ретраи с экспоненциальным бэкофом и неблокирующие задержки между попытками.
- `app/routers/webhook.py` — серверные маршруты:
  - SSE‑стримы: `GET /bitrix/webhook/push-stream` (создание) и `GET /bitrix/clear-stream` (очистка) с периодической отправкой процентов прогресса. Используют Batch API (по 50 команд в одном вызове).
  - Статус: `GET /bitrix/status` — сообщает, занята ли система (идёт ли операция).
  - POST‑маршруты без прогресса (для автоматизации): `POST /bitrix/webhook/push-to-bitrix`, `POST /bitrix/clear-bitrix`.
- `app/main.py` — рендерит HTML (Jinja2), собирая актуальные данные напрямую из Bitrix (list‑методы клиента).
- `app/templates/index.html` — UI: кнопки «Создать» и «Очистить», индикатор прогресса (SSE), таблицы компаний и контактов. Кнопки автоматически блокируются при занятости.

## Маршруты
- UI: `GET /` — страница со списками и кнопками.
- Стрим‑маршруты (прогресс):
  - `GET /bitrix/webhook/push-stream?count=100[&secret=...]`
  - `GET /bitrix/clear-stream[&secret=...]`
- Сервисный: `GET /bitrix/status` (busy: true/false)
- Дополнительно: `POST /bitrix/webhook/push-to-bitrix?count=100`, `POST /bitrix/clear-bitrix`

## Прогресс выполнения (SSE)
- Отправляется текущее значение процентов в событии `message`.
- Формула: 1% на каждые 2 обработанных элемента (из 200 операций: 100 компаний + 100 контактов). Для очистки аналогично: сначала контакты, затем компании.
- По завершении отправляется событие `done`, после чего фронтенд обновляет страницу.

## Защита от параллельных запусков
- На сервере используется глобальный `asyncio.Lock`. Пока идёт создание/очистка, повторный запуск вернёт сообщение «Сервис занят, попробуйте позже». UI опрашивает `/bitrix/status` и блокирует кнопки при занятости.

## Настройка вебхука
- Вебхук Bitrix по умолчанию жёстко задан в `app/bitrix_client.py` (константа `BITRIX_WEBHOOK_URL`).
- Рекомендуется заменить на свой в формате: `https://<портал>.bitrix24.ru/rest/<USER_ID>/<TOKEN>/`.
- Убедитесь, что вебхук имеет права CRM (crm.*). Проверка: переход по `.../profile.json` должен возвращать JSON профиля.
- Опционально можно задать `BITRIX_WEBHOOK_SECRET` (переменная окружения) — тогда все защищённые маршруты потребуют параметр `secret`.

## Запуск (Windows, PowerShell)
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
uvicorn app.main:app --reload
```
Откройте: `http://127.0.0.1:8000/`

## Особенности и ограничения
- ID в Bitrix глобальные и не сбрасываются после удаления. На UI отображается порядковый номер строки, чтобы визуально начинать «сначала».
- Batch API агрегирует до ~50 команд за один вызов. При большом числе запросов операции разбиваются на несколько батчей.
- При временных ошибках (429/5xx) клиент делает повторные попытки с экспоненциальным бэкофом.

## Как адаптировать
- Изменить объём операций: параметр `count` на `push-stream`/`push-to-bitrix`.
- Сменить источники данных/фильтры: доработать `list_companies`/`list_contacts` в клиенте и логику рендера в `main.py`.
- Доработать UI (поиск/фильтры/страниц): править `app/templates/index.html`.
