# Отчёт по практике за 17.09.2025

Прототип «Агрегатор цен и акций магазинов»

## Цель
Создать тестовую версию приложения для сбора и сравнения цен популярных товаров (на примере iPhone) из магазина ДНС для города Благовещенск, с простой веб‑страницей и API.

## Что сделано
- Сервер на Express с API и выдачей статики.
- Мок‑данные по iPhone из ДНС для Благовещенска (файл `data/dns_blagoveshchensk.json`).
- UI‑страница с фильтрами (поиск, модель, память, цвет, диапазон цен), сортировка по цене.
- Онлайн‑загрузка с сайта ДНС:
  - HTTP‑адаптер (axios + cheerio) для парсинга поисковой выдачи «iphone»;
  - Фолбэк на безголовый браузер (Puppeteer) при ответах 401/403 или антибот‑блокировке;
  - Кэширование результатов в памяти на 15 минут.
- Поддержка регионального поиска и обхода блокировок:
  - Переменная `DNS_SEARCH_URL` — URL поиска с выбранным городом;
  - Переменные `DNS_COOKIE`/`DNS_COOKIE_JSON` — передача Cookie (санитайзинг заголовка);
  - Переменная `DNS_USER_AGENT` — настраиваемый User‑Agent;
  - Отключение системного прокси по умолчанию (можно включить `USE_PROXY=true`).
- Устранены проблемы запуска на Windows (ExecutionPolicy, EPERM), добавлены инструкции в `README.md`.

## Структура проекта (важные файлы)
- `src/server.js` — сервер, API, кэш, статика, фолбэк на Puppeteer.
- `src/adapters/dns.js` — парсер через axios + cheerio.
- `src/adapters/dns_puppeteer.js` — парсер через Puppeteer (фолбэк).
- `src/adapters/dns_shared.js` — общие утилиты извлечения модели/памяти/цвета.
- `public/index.html` — UI: фильтры, кнопка «Обновить из ДНС», динамический список моделей.
- `data/dns_blagoveshchensk.json` — мок‑данные (используются как фолбэк и при пустом кэше).
- `README.md` — инструкции по запуску и настройке переменных окружения.

## API
- `GET /api/health` — проверка работоспособности.
- `POST /api/sync/dns` — загрузка данных из ДНС, кэширование (с фолбэком на Puppeteer).
- `GET /api/models` — список доступных моделей по текущим данным.
- `GET /api/products` — список товаров. Поддерживаемые параметры:
  - `query`, `model`, `memory`, `color`, `minPrice`, `maxPrice`.

## Как пользоваться (кратко)
1. Запуск:
   - Если в PowerShell блокируются скрипты: используйте `cmd /c`.
   - Команды:
     ```powershell
     cd C:\Programs\CursorProject\AggregatorTEST2
     cmd /c "npm install"
     cmd /c "npm run dev"
     ```
2. Открыть `http://localhost:3000` → нажать «Обновить из ДНС» → при необходимости выбрать модель.
3. Для точного региона/обхода 401:
   ```powershell
   $env:DNS_SEARCH_URL = "https://www.dns-shop.ru/search/?q=iphone"  # URL с выбранным городом
   $env:DNS_COOKIE_JSON = '{"region_id":"12345"}'                   # или DNS_COOKIE одной строкой
   $env:DNS_USER_AGENT = "Mozilla/5.0 ... Chrome/123 Safari/537.36"
   cmd /c "npm run dev"
   ```

## Ограничения прототипа
- Парсинг зависит от текущей вёрстки ДНС и антибот‑защиты; возможно потребуется актуализация селекторов или прокси.
- Нет постоянного хранилища (только кэш в памяти); при рестарте данные теряются.
- Рассматривается один магазин (ДНС) и один город (пример) — сравнение между магазинами не реализовано.
- Нормализация моделей/комплектаций упрощённая (эвристики).

## Предложения по развитию
- Подключить дополнительные магазины (М.Видео, Ситилинк и т.д.) и выполнить сравнение по городу/региону.
- Ввести постоянное хранилище (PostgreSQL/SQLite) и историю цен с графиками.
- Планировщик обновлений (cron/queue), ретраи и rate‑limit.
- Улучшить нормализацию моделей/памятей/цветов (словари, правила соответствий).
- Веб‑UI: пагинация, закладки, сравнение характеристик, экспорт.
- Авторизация/ключи API при публикации.

## Вывод
Прототип демонстрирует полный цикл: выдача статических данных, базовый парсинг онлайн, обработку ошибок и защит (401/прокси), работу фильтров и простую визуализацию. Этого достаточно, чтобы расширять решение до полноценного агрегатора цен по нескольким магазинам и регионам.
